<!DOCTYPE html>
<html>
<!-- 
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></scrip -->
<script language="JavaScript" type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<!-- <script language="JavaScript" type="text/javascript" src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script> -->

<style>
p {
  display: inline-block;
  font-size: 35px;
  padding: 20px;
  margin: 0;
  color: white;
}


body {background-color: black;}

.container{
  text-align: center;
  /*color: red;*/
}

.orologio{
  /*display: inline-block;*/
  font-size: 40px;
  padding: 10px;
  margin-top: 10px;
  /*text-align: center;*/
  margin-left: 100px !important;
  color: blue;
  font-weight: bold;
}

.coord{
  /*display: inline-block;*/
  font-size: 30px;
  padding: 5px;
  margin: 0;
  /*color: white;*/
  /*text-align: center;*/
}

ul{
  list-style-type: none;
  /*color: white;*/
  font-size: 25px;
}

</style>
<body>


<body onload="start()">
<p class ="orologio" id="orologio"></p>
<div class ="container" onclick="getLocation()">
  <p class="coord" id="demo"></p>
  <div id='tidedata'></div>
</div>
<!-- <button class="button, minus" onclick="getLocation()"> - </button> -->
<script>

function checkTime(i) {
    if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
    return i;
}

function start() {
  startTime()
  if (localStorage.lat == undefined || localStorage.lon == undefined){
    console.log("localStorage.lat is undefined, updating...")
    getLocation()
  }
  draw()
}

function startTime() {
  var weekday=["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"]
    var today = new Date();
    var h = today.getHours();
    var m = today.getMinutes();
    var s = today.getSeconds();
    var d = weekday[today.getDay()];
    m = checkTime(m);
    s = checkTime(s);
    document.getElementById('orologio').innerHTML = h + ":" + m + ":" + s;

    if ( Date.parse(today)-Date.parse(JSON.parse(localStorage.d)) > 1000 * 10) {
      document.getElementById('demo').style.color = "red";
      document.getElementById('tidedata').style.color = "red";
    } else {
      document.getElementById('demo').style.color = "white";
      document.getElementById('tidedata').style.color = "white";
    }

    setTimeout(startTime, 1000);
}


function getLocation() {
  console.log("calling getLocation")
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(update_position);
  } else { 
    document.getElementById("demo").innerHTML = "Geolocation is not supported by this browser.";
  }
}

function update_position(position){
  console.log("calling update_position")
  d = new Date()
  localStorage.d = JSON.stringify(d)
  // localStorage.d   = 
  localStorage.lat = position.coords.latitude.toFixed(4)
  localStorage.lon = position.coords.longitude.toFixed(4)
  get_tide_data()
  draw()
}

function draw() {
  
  var d = new Date(JSON.parse(localStorage.d))
  var datetime = d.getDate()+"/"+checkTime((d.getMonth()+1))+"/"+d.getFullYear()+" "+d.getHours()+":"+checkTime(d.getMinutes())+":"+checkTime(d.getSeconds())

  document.getElementById("demo").innerHTML = datetime + " ["+ localStorage.lat + ", " + localStorage.lon + "]"
  document.getElementById("tidedata").innerHTML = ""
  if (localStorage.tidedata == undefined) {
    get_tide_data()
  }

  var list = document.createElement("ul");
  for (let i of JSON.parse(localStorage.tidedata) ) {
    let item = document.createElement("li");
    item.innerHTML = i;
    list.appendChild(item);
  }
  document.getElementById("tidedata").appendChild(list);
}

function get_tide_data() {
  console.log("calling get_tide_data")
  lat = localStorage.lat
  lon = localStorage.lon

  settings = {
    "async": true,
    "crossDomain": true,
    "url": "https://tides.p.rapidapi.com/tides?latitude="+lat+"&longitude="+lon+"&duration=4320&interval=60",
    "method": "GET",
    "headers": {
      "x-rapidapi-key": "fbf93a6482mshd1b9ac4b389f5d3p195c26jsn2d4bc217232b",
      "x-rapidapi-host": "tides.p.rapidapi.com"
    }
  }

  data = $.ajax(settings).done(function (response) { response.extremes.map(x => [x.datetime.slice(11,16) + " " + x.state.split(/\s+/)[0] + " " + x.height.toFixed(2)] + " m") } )

  if (data.length == undefined) {
    data = ["SAMPLE DATA","02:25 LOW -0.09 m","08:19 HIGH 0.11 m","14:16 LOW -0.15 m"]
  }

  localStorage.tidedata = JSON.stringify(data)
}

</script>

</body>
</html>